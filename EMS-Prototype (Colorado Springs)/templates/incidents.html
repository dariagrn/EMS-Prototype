{% extends 'base.html' %}
{% block title %}Incident Reports - Colorado Springs EMS{% endblock %}
{% block content %}
<h1>Incident Reports</h1>
<table class="table table-bordered table-hover mt-4">
  <thead class="table-light">
    <tr>
      <th>Select</th>
      <th>ID</th>
      <th>Timestamp</th>
      <th>Name</th>
      <th>Phone</th>
      <th>Type</th>
      <th>Location</th>
      <th>Severity Level</th>
      <th>Admin Reply</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for i in incidents %}
    <tr>
      <td><input type="radio" name="selected_incident" value="{{ i.id }}" onclick="selectIncident({{ i.id }}, '{{ i.admin_reply|escape }}')"></td>
      <td>{{ i.id }}</td>
      <td>{{ i.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>{{ i.name }}</td>
      <td>{{ i.phone }}</td>
      <td>{{ i.emergency_type }}</td>
      <td>{{ i.location }}</td>
      <td>{{ i.severity_level }}</td>
      <td>{% if i.admin_reply %}<div class="text-success">{{ i.admin_reply }}</div>{% else %}<span class="text-muted">No reply</span>{% endif %}</td>
      <td>
        <form method="post" action="{{ url_for('delete_incident', incident_id=i.id) }}" onsubmit="return confirm('Are you sure you want to delete this incident?');">
          <button type="submit" class="btn btn-danger btn-sm">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="10" class="text-center">No incident reports found.</td></tr>
    {% endfor %}
  </tbody>
</table>
<div class="row mt-5 justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Active Incident Response</h5>
        <form id="replyForm" method="post">
          <input type="hidden" name="incident_id" id="incident_id">
          <div class="mb-3">
            <label for="admin_reply" class="form-label">Response to User</label>
            <textarea name="admin_reply" id="admin_reply" class="form-control" rows="4" placeholder="Type your reply..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary" id="replyBtn" disabled>Send Reply</button>
        </form>
        <div id="currentReply" class="mt-3 text-success"></div>
      </div>
    </div>
  </div>
</div>
<script>
function selectIncident(id, reply) {
  document.getElementById('incident_id').value = id;
  document.getElementById('replyBtn').disabled = false;
  document.getElementById('admin_reply').value = '';
  document.getElementById('currentReply').textContent = reply ? 'Current reply: ' + reply : '';
  document.getElementById('replyForm').action = '/incidents/' + id + '/reply';
}
</script>
{% endblock %}
