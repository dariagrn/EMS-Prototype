{% extends 'base.html' %}
{% block title %}Dashboard - EMS Prototype{% endblock %}
{% block content %}
  <div class="pt-5"></div>
  <h1 class="mb-5">Dashboard</h1>
  <!-- Filter Boxes Row -->
  <div class="mb-4 d-flex justify-content-center">
    <div class="d-inline-flex gap-5">
      <div class="card text-center shadow-sm filter-box" id="filter-active" style="min-width:300px; min-height:160px; cursor:pointer;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center h-100">
          <h5 class="card-title mb-2 fs-3">Active Incidents</h5>
          <div class="display-3 fw-bold" id="count-active">0</div>
        </div>
      </div>
      <div class="card text-center shadow-sm filter-box" id="filter-resolved" style="min-width:300px; min-height:160px; cursor:pointer;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center h-100">
          <h5 class="card-title mb-2 fs-3">Resolved Today</h5>
          <div class="display-3 fw-bold" id="count-resolved">0</div>
        </div>
      </div>
      <div class="card text-center shadow-sm filter-box" id="filter-responders" style="min-width:300px; min-height:160px; cursor:pointer;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center h-100">
          <h5 class="card-title mb-2 fs-3">Responders Active</h5>
          <div class="display-3 fw-bold" id="count-responders">0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-5 d-flex justify-content-center">
    <div class="d-inline-flex gap-4">
      <button class="btn btn-danger btn-xl px-5 py-3 fs-2" data-bs-toggle="modal" data-bs-target="#emergencyModal">
        <i class="bi bi-plus-lg me-2"></i>Report New Emergency
      </button>
      <button class="btn btn-outline-primary btn-xl px-5 py-3 fs-2" id="viewReportsBtn">
        <i class="bi bi-list-ul me-2"></i>View Your Reports
      </button>
    </div>
  </div>

  <!-- Active Incidents Map -->
  <div class="mb-4">
    <h1>Active Incidents Map</h1>
    <div id="incidentsMap" style="height: 400px; width: 100%;"></div>
  </div>


  <!-- Emergency Incident Modal -->
  <div class="modal fade" id="emergencyModal" tabindex="-1" aria-labelledby="emergencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="emergencyForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title" id="emergencyModalLabel">Report Emergency Incident</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="incidentName" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="incidentName" name="name" required>
            </div>
            <div class="mb-3">
              <label for="incidentPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="incidentPhone" name="phone" required>
            </div>
            <div class="mb-3">
              <label for="incidentType" class="form-label">Emergency Type</label>
              <select class="form-select" id="incidentType" name="type" required>
                <option value="">Select type</option>
                <option>Fire</option>
                <option>Medical</option>
                <option>Security</option>
                <option>Utility</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="incidentLocation" class="form-label">Incident Location (Colorado Springs)</label>
              <select class="form-select" id="incidentLocation" name="location" required>
                <option value="">Select location</option>
                <option>Briargate</option>
                <option>Central</option>
                <option>Downtown</option>
                <option>East Colorado Springs</option>
                <option>Falcon</option>
                <option>Manitou Springs</option>
                <option>Northgate</option>
                <option>Old Colorado City</option>
                <option>Powers</option>
                <option>Rockrimmon</option>
                <option>Security-Widefield</option>
                <option>Southwest</option>
                <option>West Colorado Springs</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="severitySlider" class="form-label">Severity Level (1-10): <span id="severityValue">5</span></label>
              <input type="range" class="form-range" min="1" max="10" step="1" id="severitySlider" name="severity" value="5" required>
              <div class="d-flex justify-content-between small">
                <span>Low (1)</span>
                <span>Medium (5)</span>
                <span>High (10)</span>
              </div>
            </div>
            <div class="mb-3">
              <label for="incidentDescription" class="form-label">Emergency Description</label>
              <textarea class="form-control" id="incidentDescription" name="description" rows="3" placeholder="Describe the emergency..." required></textarea>
            </div>
            <div class="mb-3">
              <label for="incidentMedia" class="form-label">Photo/Video (optional)</label>
              <div id="mediaDropZone" class="border rounded p-3 text-center bg-light" style="cursor:pointer;">
                <span id="mediaDropText">Drag & Drop files here or click to select</span>
                <input class="form-control d-none" type="file" id="incidentMedia" name="media" accept="image/*,video/*">
              </div>
              <div id="mediaPreview" class="mt-2"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Submit Report</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Reports Modal -->
  <div class="modal fade" id="userReportsModal" tabindex="-1" aria-labelledby="userReportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userReportsModalLabel">Your Emergency Reports</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="userReportsTableWrapper">
            <div class="text-center text-muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('energyChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: { labels: ['Jan','Feb','Mar','Apr','May'], datasets: [{label:'kWh', data:[100,200,150,300,250], borderColor:'rgb(75,192,192)', tension:0.3}] },
      });
    }
    const ctx2 = document.getElementById('breakdownChart');
    if (ctx2) {
      new Chart(ctx2, { type:'doughnut', data:{ labels:['HVAC','Lighting','Other'], datasets:[{data:[60,25,15], backgroundColor:['#007bff','#28a745','#ffc107']}] } });
    }

    // Severity slider value display
    document.addEventListener('DOMContentLoaded', function() {
      var slider = document.getElementById('severitySlider');
      var valueSpan = document.getElementById('severityValue');
      if (slider && valueSpan) {
        slider.addEventListener('input', function() {
          valueSpan.textContent = slider.value;
        });
      }
      // Drag and drop for media upload
      var dropZone = document.getElementById('mediaDropZone');
      var fileInput = document.getElementById('incidentMedia');
      var preview = document.getElementById('mediaPreview');
      if (dropZone && fileInput) {
        dropZone.addEventListener('click', function() { fileInput.click(); });
        dropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropZone.classList.add('bg-primary', 'text-white');
        });
        dropZone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          dropZone.classList.remove('bg-primary', 'text-white');
        });
        dropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          dropZone.classList.remove('bg-primary', 'text-white');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            showPreview(fileInput.files[0]);
          }
        });
        fileInput.addEventListener('change', function() {
          if (fileInput.files && fileInput.files[0]) {
            showPreview(fileInput.files[0]);
          }
        });
        function showPreview(file) {
          preview.innerHTML = '';
          if (!file) return;
          if (file.type.startsWith('image/')) {
            var img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'img-thumbnail';
            img.style.maxWidth = '150px';
            img.onload = function() { URL.revokeObjectURL(img.src); };
            preview.appendChild(img);
          } else if (file.type.startsWith('video/')) {
            var vid = document.createElement('video');
            vid.src = URL.createObjectURL(file);
            vid.controls = true;
            vid.style.maxWidth = '150px';
            vid.onload = function() { URL.revokeObjectURL(vid.src); };
            preview.appendChild(vid);
          } else {
            preview.textContent = file.name;
          }
        }
      }
      // Emergency form submit handler (AJAX)
      var form = document.getElementById('emergencyForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          var formData = new FormData(form);
          fetch('/api/report-incident', {
            method: 'POST',
            body: formData
          })
          .then(resp => resp.json().then(j => ({ok: resp.ok, status: resp.status, json: j})))
          .then(result => {
            if (result.ok) {
              form.reset();
              if (slider && valueSpan) valueSpan.textContent = slider.value;
              if (preview) preview.innerHTML = '';
              var modal = bootstrap.Modal.getInstance(document.getElementById('emergencyModal'));
              modal.hide();
              alert('Emergency incident reported!');
              // Update Active Incidents count
              fetch('/api/active-incidents-count')
                .then(resp => resp.json())
                .then(data => {
                  document.getElementById('count-active').textContent = data.count;
                });
            } else {
              alert(result.json.message || 'Failed to submit report.');
            }
          })
          .catch(() => alert('Failed to submit report.'));
        });
      }
      // View Your Reports button handler
      var viewBtn = document.getElementById('viewReportsBtn');
      if (viewBtn) {
        viewBtn.addEventListener('click', function() {
          var modal = new bootstrap.Modal(document.getElementById('userReportsModal'));
          var wrapper = document.getElementById('userReportsTableWrapper');
          wrapper.innerHTML = '<div class="text-center text-muted">Loading...</div>';
          fetch('/api/user-reports')
            .then(resp => resp.json())
            .then(data => {
              if (Array.isArray(data) && data.length > 0) {
                var table = '<table class="table table-bordered table-hover"><thead><tr><th>Date</th><th>Type</th><th>Location</th><th>Severity</th><th>Description</th><th>Media</th></tr></thead><tbody>';
                data.forEach(function(r) {
                  let mediaCell = r.media_filename ? `<a href='/uploads/${r.media_filename}' target='_blank'>View</a>` : '';
                  table += `<tr><td>${r.timestamp ? r.timestamp.substring(0,16).replace('T',' ') : ''}</td><td>${r.emergency_type}</td><td>${r.location}</td><td>${r.severity_level}</td><td>${r.description||''}</td><td>${mediaCell}</td></tr>`;
                });
                table += '</tbody></table>';
                wrapper.innerHTML = table;
              } else {
                wrapper.innerHTML = '<div class="text-center text-muted">No reports found.</div>';
              }
            })
            .catch(() => {
              wrapper.innerHTML = '<div class="text-center text-danger">Failed to load reports.</div>';
            });
          modal.show();
        });
      }
      // Active Incidents Map
      var map = L.map('incidentsMap').setView([38.8339, -104.8214], 12); // Colorado Springs
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      fetch('/api/active-incidents')
        .then(resp => resp.json())
        .then(data => {
          data.forEach(function(incident) {
            if (incident.location_coords) {
              var marker = L.marker(incident.location_coords).addTo(map);
              marker.bindPopup(
                `<b>${incident.emergency_type}</b><br>` +
                `<div><strong>Summary:</strong> ${incident.description || 'No description provided.'}</div>` +
                `<div>${incident.location}</div>` +
                `<div>Severity: ${incident.severity_level}</div>`
              );
            }
          });
        });
      // Filter boxes logic (demo counts, replace with real data as needed)
      // Example: fetch and update filter box counts (replace with real endpoints if available)
      fetch('/api/user-reports')
        .then(resp => resp.json())
        .then(data => {
          // Demo logic: count active, resolved today, responders active
          let active = 0, resolved = 0, responders = 0;
          const today = new Date().toISOString().slice(0, 10);
          data.forEach(r => {
            // Assume 'active' if no resolved flag, 'resolved' if timestamp is today and has a resolved flag
            if (!r.resolved) active++;
            if (r.resolved && r.timestamp && r.timestamp.startsWith(today)) resolved++;
            // Demo: count responders as unique phone numbers for active incidents
            if (!r.resolved) responders++;
          });
          document.getElementById('count-active').textContent = active;
          document.getElementById('count-resolved').textContent = resolved;
          document.getElementById('count-responders').textContent = responders;
        });
      // Filter box click highlight (demo only)
      document.querySelectorAll('.filter-box').forEach(box => {
        box.addEventListener('click', function() {
          document.querySelectorAll('.filter-box').forEach(b => b.classList.remove('active'));
          box.classList.add('active');
          // TODO: filter incidents/reports based on box selection
        });
      });
    });
  </script>
{% endblock %}